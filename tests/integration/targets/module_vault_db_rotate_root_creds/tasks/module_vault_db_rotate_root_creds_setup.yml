---
- name: Configuration tasks
  module_defaults:
    vault_ci_token_create: '{{ vault_plugins_module_defaults_common }}'
    vault_ci_enable_engine: '{{ vault_plugins_module_defaults_common }}'
    vault_ci_read: '{{ vault_plugins_module_defaults_common }}'
    vault_ci_write: '{{ vault_plugins_module_defaults_common }}'
    vault_ci_policy_put: '{{ vault_plugins_module_defaults_common }}'
  block:
    - name: Create a test non-root token
      vault_ci_token_create:
        policies: [policy-database-all]
      register: user_token_cmd

    - name: Set facts
      ansible.builtin.set_fact:
        db_user: usr_to_rotate
        db_password: SuperSecret

    - name: Create a new user in PostgreSQL
      community.postgresql.postgresql_user:
        db: "{{ vault_postgres_db }}"
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        login_user: "{{ vault_postgres_user }}"
        login_password: "{{ vault_postgres_password }}"
        port: "{{ vault_postgres_port }}"
        login_host: "{{ vault_postgres_host }}"
        role_attr_flags: SUPERUSER

    - name: Create the Database Connection
      vault_ci_write:
        path: "/{{ vault_database_path }}/config/{{ db_user }}"
        data:
          plugin_name: "{{ vault_database_plugin_name }}"
          connection_url: "{{ vault_database_connection_url }}"
          allowed_roles: '*'
          username: "{{ db_user }}"
          password: "{{ db_password }}"
